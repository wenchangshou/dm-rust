# é‡æ–°è®¾è®¡çš„Rustè®¾å¤‡æ§åˆ¶ç³»ç»Ÿæ¶æ„

## ğŸ¯ è®¾è®¡ç†å¿µ

æœ¬æ¬¡é‡æ„åŸºäº**å…³æ³¨ç‚¹åˆ†ç¦»**å’Œ**èŒè´£æ¸…æ™°**çš„åŸåˆ™ï¼Œå°†åŸNode.jsç‰ˆæœ¬çš„å•ä½“ç»“æ„æ‹†åˆ†ä¸ºå¤šä¸ªä¸“æ³¨çš„æ¨¡å—ï¼Œå……åˆ†åˆ©ç”¨Rustçš„ç±»å‹ç³»ç»Ÿå’Œå¹¶å‘ç‰¹æ€§ã€‚

---

## ğŸ“ æ ¸å¿ƒæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  DeviceController                       â”‚
â”‚            ï¼ˆæ ¸å¿ƒåè°ƒå™¨ - Facadeæ¨¡å¼ï¼‰                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚            â”‚         â”‚          â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â” â”Œâ–¼â”€â”€â”€â”€â”€â”€â”  â”Œâ–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ChannelManagerâ”‚  â”‚NodeManagerâ”‚ â”‚TaskSchedâ”‚ â”‚SceneExec â”‚
    â”‚(é€šé“ç®¡ç†)    â”‚  â”‚(èŠ‚ç‚¹çŠ¶æ€) â”‚ â”‚(ä»»åŠ¡é˜Ÿåˆ—)â”‚ â”‚(åœºæ™¯ç¼–æ’) â”‚
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚                â”‚            â”‚
      â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚Protocol â”‚      â”‚NodeStateâ”‚  â”‚DependResolverâ”‚
      â”‚instancesâ”‚      â”‚  Map    â”‚  â”‚ (ä¾èµ–æ£€æŸ¥)  â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”§ æ¨¡å—èŒè´£è¯¦è§£

### 1. DeviceControllerï¼ˆè®¾å¤‡æ§åˆ¶å™¨ï¼‰
**èŒè´£ï¼š** ç³»ç»Ÿå…¥å£ï¼Œåè°ƒå„å­æ¨¡å—

**å…³é”®æ–¹æ³•ï¼š**
- `write_node(global_id, value)` - å†™å…¥èŠ‚ç‚¹ï¼ˆå¸¦ä¾èµ–æ£€æŸ¥ï¼‰
- `read_node(global_id)` - è¯»å–èŠ‚ç‚¹
- `execute_scene(scene_name)` - æ‰§è¡Œåœºæ™¯
- `subscribe_events()` - è®¢é˜…ç³»ç»Ÿäº‹ä»¶

**ç‰¹ç‚¹ï¼š**
- ä¸ç›´æ¥æ“ä½œç¡¬ä»¶ï¼Œé€šè¿‡ChannelManagerä»£ç†
- ç»Ÿä¸€çš„é”™è¯¯å¤„ç†
- äº‹ä»¶é©±åŠ¨é€šçŸ¥æœºåˆ¶

---

### 2. ChannelManagerï¼ˆé€šé“ç®¡ç†å™¨ï¼‰
**èŒè´£ï¼š** ç®¡ç†æ‰€æœ‰ç‰©ç†é€šé“ï¼Œéš”ç¦»åè®®ç»†èŠ‚

**æ•°æ®ç»“æ„ï¼š**
```rust
DashMap<ChannelId, Channel>
  â””â”€ Channel {
       id: u32,
       protocol: Arc<RwLock<Box<dyn Protocol>>>,
       config: ChannelConfig,
     }
```

**å…³é”®æ–¹æ³•ï¼š**
- `write(channel_id, device_id, value)` - åŸå­å†™æ“ä½œ
- `read(channel_id, device_id)` - åŸå­è¯»æ“ä½œ
- `execute(channel_id, command, params)` - æ‰§è¡Œåè®®å‘½ä»¤
- `get_all_status()` - æ‰¹é‡è·å–çŠ¶æ€

**ä¼˜åŠ¿ï¼š**
- ä½¿ç”¨DashMapå®ç°æ— é”å¹¶å‘è®¿é—®
- RwLockä¿è¯å•é€šé“å†…çš„è¯»å†™ä¸€è‡´æ€§
- åè®®å®ä¾‹å®Œå…¨å°è£…ï¼Œå¤–éƒ¨ä¸æ„ŸçŸ¥å…·ä½“å®ç°

---

### 3. NodeManagerï¼ˆèŠ‚ç‚¹ç®¡ç†å™¨ï¼‰
**èŒè´£ï¼š** ç»´æŠ¤èŠ‚ç‚¹é…ç½®å’Œè¿è¡Œæ—¶çŠ¶æ€

**æ•°æ®ç»“æ„ï¼š**
```rust
nodes: DashMap<GlobalId, NodeConfig>   // é…ç½®ä¿¡æ¯
states: DashMap<GlobalId, NodeState>   // è¿è¡Œæ—¶çŠ¶æ€
```

**NodeState ç»“æ„ï¼š**
```rust
pub struct NodeState {
    global_id: u32,
    channel_id: u32,
    device_id: u32,
    category: String,
    alias: String,
    current_value: Option<i32>,  // å½“å‰å€¼
    online: bool,                 // åœ¨çº¿çŠ¶æ€
    last_update: Option<Instant>, // æœ€åæ›´æ–°æ—¶é—´
}
```

**å…³é”®æ–¹æ³•ï¼š**
- `get_node(global_id)` - è·å–èŠ‚ç‚¹é…ç½®
- `get_state(global_id)` - è·å–èŠ‚ç‚¹çŠ¶æ€
- `update_value(global_id, value)` - æ›´æ–°å€¼å¹¶è§¦å‘äº‹ä»¶
- `find_global_id(channel_id, device_id)` - åå‘æŸ¥æ‰¾

**æ”¹è¿›ç‚¹ï¼š**
- é…ç½®å’ŒçŠ¶æ€åˆ†ç¦»å­˜å‚¨
- è‡ªåŠ¨ç»´æŠ¤æœ€åæ›´æ–°æ—¶é—´
- çŠ¶æ€å˜åŒ–è‡ªåŠ¨å‘é€äº‹ä»¶

---

### 4. DependencyResolverï¼ˆä¾èµ–è§£æå™¨ï¼‰
**èŒè´£ï¼š** æ£€æŸ¥å’Œè‡ªåŠ¨æ»¡è¶³èŠ‚ç‚¹ä¾èµ–æ¡ä»¶

**æ ¸å¿ƒé€»è¾‘ï¼š**
```rust
async fn check_dependencies(&self, deps: &[Dependency]) -> Result<bool> {
    for dep in deps {
        // æ”¯æŒä¸¤ç§ä¾èµ–ç±»å‹ï¼š
        // 1. å€¼ä¾èµ–: dep.value == node.current_value
        // 2. çŠ¶æ€ä¾èµ–: dep.status == node.online
    }
}

async fn fulfill_dependencies(&self, deps: &[Dependency]) -> Result<()> {
    // è‡ªåŠ¨è®¾ç½®ä¾èµ–èŠ‚ç‚¹åˆ°ç›®æ ‡çŠ¶æ€ï¼ˆç”¨äºautoç­–ç•¥ï¼‰
}
```

**æ”¯æŒçš„ä¾èµ–é…ç½®ï¼š**
```json
{
  "depend": [
    { "id": 1, "value": 1 },           // èŠ‚ç‚¹1å¿…é¡»ä¸º1
    { "channel_id": 2, "id": 3, "status": true }  // é€šé“2è®¾å¤‡3å¿…é¡»åœ¨çº¿
  ],
  "depend_strategy": "auto"  // auto: è‡ªåŠ¨æ»¡è¶³ | manual: ä»…æ£€æŸ¥
}
```

---

### 5. TaskSchedulerï¼ˆä»»åŠ¡è°ƒåº¦å™¨ï¼‰
**èŒè´£ï¼š** ç®¡ç†ä¾èµ–æœªæ»¡è¶³çš„ä»»åŠ¡é˜Ÿåˆ—

**ä»»åŠ¡ç”Ÿå‘½å‘¨æœŸï¼š**
```
æäº¤ â†’ Pending â†’ æ£€æŸ¥ä¾èµ– â†’ Executing â†’ Completed
         â†“                      â†“
      è¶…æ—¶/å¤±è´¥              é‡è¯•/å¤±è´¥
```

**Task ç»“æ„ï¼š**
```rust
pub struct Task {
    id: String,          // UUID
    global_id: u32,
    value: i32,
    status: TaskStatus,
    created_at: Instant,
    retry_count: u32,
    node_config: NodeConfig,  // æºå¸¦å®Œæ•´é…ç½®
}
```

**è°ƒåº¦ç­–ç•¥ï¼š**
- æ¯500msæ£€æŸ¥ä¸€æ¬¡é˜Ÿåˆ—ï¼ˆå¯é…ç½®ï¼‰
- è¶…æ—¶æ—¶é—´ï¼š5ç§’ï¼ˆå¯é…ç½®ï¼‰
- æœ€å¤§é‡è¯•æ¬¡æ•°ï¼š3æ¬¡ï¼ˆå¯é…ç½®ï¼‰
- ä½¿ç”¨VecDequeå®ç°FIFOé˜Ÿåˆ—

**å…³é”®æ”¹è¿›ï¼š**
- ç‹¬ç«‹åå°ä»»åŠ¡ï¼Œä¸é˜»å¡ä¸»æµç¨‹
- è¯¦ç»†çš„ä»»åŠ¡çŠ¶æ€è·Ÿè¸ª
- ä»»åŠ¡å®Œæˆäº‹ä»¶é€šçŸ¥

---

### 6. SceneExecutorï¼ˆåœºæ™¯æ‰§è¡Œå™¨ï¼‰
**èŒè´£ï¼š** ç¼–æ’å’Œæ‰§è¡Œåœºæ™¯ä¸­çš„å¤šèŠ‚ç‚¹æ“ä½œ

**åœºæ™¯æ‰§è¡Œæµç¨‹ï¼š**
```
åŠ è½½åœºæ™¯é…ç½®
  â†“
éå†åœºæ™¯èŠ‚ç‚¹
  â†“
ç­‰å¾…delayï¼ˆå¦‚æœæœ‰ï¼‰
  â†“
è°ƒç”¨controller.write_node()
  â†“
å‘é€è¿›åº¦äº‹ä»¶
  â†“
è¿”å›æ€»ä½“ç»“æœ
```

**åœºæ™¯é…ç½®ç¤ºä¾‹ï¼š**
```json
{
  "name": "å¼€æœºåœºæ™¯",
  "nodes": [
    { "id": 1, "value": 1, "delay": 0 },
    { "id": 2, "value": 1, "delay": 1000 },
    { "id": 3, "value": 1, "delay": 2000 }
  ]
}
```

**ç‰¹ç‚¹ï¼š**
- æ”¯æŒèŠ‚ç‚¹é—´å»¶è¿Ÿ
- åœºæ™¯æ‰§è¡Œå¤±è´¥ä¸å½±å“å…¶ä»–èŠ‚ç‚¹
- å‘é€åœºæ™¯å¼€å§‹/å®Œæˆäº‹ä»¶

---

## ğŸ”„ äº‹ä»¶é©±åŠ¨æ¶æ„

### DeviceEvent æšä¸¾

```rust
pub enum DeviceEvent {
    NodeStateChanged { global_id, old_value, new_value },
    ChannelConnected { channel_id },
    ChannelDisconnected { channel_id, reason },
    TaskCompleted { task_id, success },
    SceneStarted { scene_name },
    SceneCompleted { scene_name, success },
}
```

### äº‹ä»¶æµ

```
äº‹ä»¶æº â†’ broadcast::Sender â†’ å¤šä¸ªè®¢é˜…è€…
                  â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚         â”‚         â”‚
    WebSocket   æ—¥å¿—   çŠ¶æ€åŒæ­¥
```

### è®¢é˜…ç¤ºä¾‹

```rust
let mut rx = controller.subscribe_events();
while let Ok(event) = rx.recv().await {
    match event {
        DeviceEvent::NodeStateChanged { global_id, .. } => {
            // é€šçŸ¥å‰ç«¯æ›´æ–°
        }
        _ => {}
    }
}
```

---

## ğŸš€ å…³é”®æ”¹è¿›ç‚¹

### 1. ç±»å‹å®‰å…¨
**Before (JS):**
```javascript
const node = this.getOneNode(id)  // å¯èƒ½è¿”å›undefined
node.value = value                 // è¿è¡Œæ—¶é”™è¯¯
```

**After (Rust):**
```rust
let node = self.node_manager.get_node(id)
    .ok_or_else(|| DeviceError::DeviceNotFound(...))?;
// ç¼–è¯‘æœŸä¿è¯nodeå­˜åœ¨
```

### 2. å¹¶å‘å®‰å…¨
**Before (JS):** å•çº¿ç¨‹äº‹ä»¶å¾ªç¯ï¼Œæ— æ³•çœŸæ­£å¹¶å‘
**After (Rust):** 
- DashMapï¼šæ— é”å¹¶å‘Map
- RwLockï¼šè¯»å¤šå†™å°‘åœºæ™¯
- broadcastï¼šå¤šè®¢é˜…è€…äº‹ä»¶

### 3. é”™è¯¯å¤„ç†
**Before (JS):**
```javascript
try {
  await device.write(value)
} catch (e) {
  console.error(e)  // å¯èƒ½è¢«å¿½ç•¥
}
```

**After (Rust):**
```rust
self.write(value).await?  // å¼ºåˆ¶å¤„ç†é”™è¯¯
```

### 4. ä¾èµ–ç®¡ç†æ¸…æ™°åŒ–
**Before (JS):** ä¾èµ–æ£€æŸ¥é€»è¾‘æ•£è½åœ¨å¤šå¤„
**After (Rust):** ç»Ÿä¸€ç”±DependencyResolverå¤„ç†

---

## ğŸ“Š æ€§èƒ½å¯¹æ¯”ï¼ˆé¢„æœŸï¼‰

| æŒ‡æ ‡ | Node.js | Rust |
|-----|---------|------|
| å¯åŠ¨æ—¶é—´ | ~500ms | <100ms |
| å†…å­˜å ç”¨ | ~150MB | <30MB |
| å¹¶å‘å¤„ç† | å•çº¿ç¨‹ | å¤šçº¿ç¨‹å¼‚æ­¥ |
| å“åº”å»¶è¿Ÿ | ~50ms | <10ms |
| ç±»å‹æ£€æŸ¥ | è¿è¡Œæ—¶ | ç¼–è¯‘æ—¶ |

---

## ğŸ” çº¿ç¨‹å®‰å…¨ä¿è¯

```
Arc: å¼•ç”¨è®¡æ•°ï¼Œè·¨çº¿ç¨‹å…±äº«
  â””â”€ DashMap: åˆ†æ®µé”ï¼Œå¹¶å‘è¯»å†™
  â””â”€ RwLock: è¯»å†™é”ï¼Œè¯»å¤šå†™å°‘
  â””â”€ broadcast: å¤šç”Ÿäº§è€…å¤šæ¶ˆè´¹è€…

æ‰€æœ‰çŠ¶æ€ä¿®æ”¹éƒ½é€šè¿‡å†…éƒ¨å¯å˜æ€§å®ç°ï¼Œå¤–éƒ¨æ¥å£ä¸å¯å˜
```

---

## ğŸ“ ä½¿ç”¨ç¤ºä¾‹

### åŸºç¡€å†™å…¥
```rust
// è‡ªåŠ¨å¤„ç†ä¾èµ–
controller.write_node(global_id, 1).await?;
```

### æ‰§è¡Œåœºæ™¯
```rust
controller.execute_scene("å¼€æœºåœºæ™¯").await?;
```

### è®¢é˜…äº‹ä»¶
```rust
let mut events = controller.subscribe_events();
tokio::spawn(async move {
    while let Ok(event) = events.recv().await {
        println!("äº‹ä»¶: {:?}", event);
    }
});
```

---

## ğŸ¯ ä¸‹ä¸€æ­¥å¼€å‘å»ºè®®

1. **å®Œå–„åè®®å®ç°**ï¼šè¡¥å……PJLinkã€Modbusç­‰å…·ä½“é€»è¾‘
2. **é…ç½®æ–‡ä»¶åŠ è½½**ï¼šå®ç°ä»JSON/TOMLåŠ è½½é…ç½®
3. **çŠ¶æ€æŒä¹…åŒ–**ï¼šèŠ‚ç‚¹çŠ¶æ€ä¿å­˜åˆ°æ•°æ®åº“
4. **ç›‘æ§æŒ‡æ ‡**ï¼šæ·»åŠ Prometheus metrics
5. **ä¼˜é›…å…³é—­**ï¼šç¡®ä¿ä»»åŠ¡é˜Ÿåˆ—æ¸…ç©ºåé€€å‡º
6. **å•å…ƒæµ‹è¯•**ï¼šä¸ºæ¯ä¸ªæ¨¡å—æ·»åŠ æµ‹è¯•

---

**æ€»ç»“ï¼š** æ–°æ¶æ„é€šè¿‡æ¨¡å—åŒ–ã€äº‹ä»¶é©±åŠ¨å’Œç±»å‹å®‰å…¨ï¼Œå®ç°äº†ä¸€ä¸ªå¯æ‰©å±•ã€é«˜æ€§èƒ½ã€æ˜“ç»´æŠ¤çš„è®¾å¤‡æ§åˆ¶ç³»ç»Ÿã€‚
